<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Yogesh Dairy Manager</title>
<link href="https://fonts.googleapis.com/css2?family=Sora:wght@300;400;600;700;800&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #0f1117; --surface: #1a1d27; --surface2: #22263a; --border: #2e3245;
  --accent: #f5a623; --green: #34d399; --red: #f87171; --blue: #60a5fa;
  --purple: #a78bfa; --text: #f0f0f5; --muted: #6b7280;
  --cow: #f5a623; --buffalo: #60a5fa; --morning: #fbbf24; --evening: #818cf8;
  --radius: 14px; --radius-sm: 8px;
}
* { box-sizing: border-box; margin: 0; padding: 0; }
body { font-family: 'Sora', sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; font-size: 14px; }
::-webkit-scrollbar { width: 4px; } ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }

/* LOGIN */
#login-screen { position: fixed; inset: 0; background: var(--bg); display: flex; align-items: center; justify-content: center; z-index: 9999; padding: 20px; }
.login-box { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); padding: 36px 28px; width: 100%; max-width: 340px; text-align: center; }
.login-logo { font-size: 48px; margin-bottom: 10px; }
.login-box h2 { font-size: 22px; font-weight: 800; margin-bottom: 4px; }
.login-box p { font-size: 13px; color: var(--muted); margin-bottom: 24px; }
.pin-dots { display: flex; justify-content: center; gap: 14px; margin-bottom: 28px; }
.pin-dot { width: 16px; height: 16px; border-radius: 50%; border: 2px solid var(--border); background: transparent; transition: all 0.2s; }
.pin-dot.filled { background: var(--accent); border-color: var(--accent); box-shadow: 0 0 8px rgba(245,166,35,0.5); }
.pin-keypad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; max-width: 240px; margin: 0 auto; }
.pin-key { padding: 16px; border-radius: var(--radius-sm); border: 1px solid var(--border); background: var(--surface2); font-family: 'Sora', sans-serif; font-size: 18px; font-weight: 700; color: var(--text); cursor: pointer; transition: all 0.15s; user-select: none; }
.pin-key:hover { background: var(--border); } .pin-key:active { transform: scale(0.93); }
.pin-key.del { font-size: 14px; color: var(--muted); } .pin-key.zero { grid-column: 2; }
.pin-error { color: var(--red); font-size: 12px; margin-top: 14px; min-height: 18px; font-weight: 600; }
.pin-hint { font-size: 11px; color: var(--muted); margin-top: 10px; line-height: 1.5; }

/* HEADER */
header { background: var(--surface); border-bottom: 1px solid var(--border); padding: 14px 18px; display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; z-index: 200; }
.header-left { display: flex; align-items: center; gap: 12px; }
.logo-box { width: 40px; height: 40px; background: linear-gradient(135deg, var(--accent), #e8841a); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 20px; }
header h1 { font-size: 17px; font-weight: 800; } header p { font-size: 11px; color: var(--muted); }
.header-actions { display: flex; gap: 8px; align-items: center; }
.sync-btn { display: flex; align-items: center; gap: 6px; padding: 8px 12px; border-radius: var(--radius-sm); border: 1px solid var(--border); background: var(--surface2); color: var(--muted); font-family: 'Sora', sans-serif; font-size: 12px; cursor: pointer; transition: all 0.2s; }
.sync-btn.connected { border-color: var(--green); color: var(--green); }
.sync-dot { width: 7px; height: 7px; border-radius: 50%; background: var(--muted); flex-shrink: 0; }
.sync-dot.on { background: var(--green); box-shadow: 0 0 6px var(--green); }
.lock-btn { padding: 8px 12px; border-radius: var(--radius-sm); border: 1px solid var(--border); background: var(--surface2); color: var(--muted); font-size: 13px; cursor: pointer; font-family: 'Sora', sans-serif; transition: all 0.2s; }
.lock-btn:hover { border-color: var(--red); color: var(--red); }

/* TABS */
.tabs { background: var(--surface); border-bottom: 1px solid var(--border); display: flex; overflow-x: auto; padding: 0 4px; }
.tab-btn { padding: 13px 15px; border: none; background: none; font-family: 'Sora', sans-serif; font-size: 12px; font-weight: 500; color: var(--muted); cursor: pointer; border-bottom: 2px solid transparent; white-space: nowrap; transition: all 0.2s; }
.tab-btn.active { color: var(--accent); border-bottom-color: var(--accent); font-weight: 700; }

main { padding: 16px; max-width: 720px; margin: 0 auto; }
.section { display: none; } .section.active { display: block; }

.loading-screen { text-align: center; padding: 50px 20px; }
.spinner-big { width: 38px; height: 38px; border: 3px solid rgba(245,166,35,0.2); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.8s linear infinite; margin: 0 auto 14px; }
@keyframes spin { to { transform: rotate(360deg); } }
.loading-screen p { color: var(--muted); font-size: 13px; }

.banner { background: rgba(245,166,35,0.08); border: 1px solid rgba(245,166,35,0.3); border-radius: var(--radius-sm); padding: 12px 16px; margin-bottom: 14px; display: flex; align-items: center; gap: 10px; font-size: 13px; }
.banner button { margin-left: auto; flex-shrink: 0; }

.card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); padding: 18px; margin-bottom: 14px; }
.card-title { font-size: 15px; font-weight: 700; margin-bottom: 16px; display: flex; align-items: center; gap: 8px; }

.form-row { display: flex; gap: 10px; margin-bottom: 12px; flex-wrap: wrap; }
.form-group { flex: 1; min-width: 130px; }
label { display: block; font-size: 11px; font-weight: 600; color: var(--muted); text-transform: uppercase; letter-spacing: 0.6px; margin-bottom: 5px; }
input, select { width: 100%; padding: 10px 12px; border: 1px solid var(--border); border-radius: var(--radius-sm); background: var(--surface2); color: var(--text); font-family: 'Sora', sans-serif; font-size: 13px; transition: border-color 0.2s; }
input:focus, select:focus { outline: none; border-color: var(--accent); }
input::placeholder { color: var(--muted); } select option { background: var(--surface2); }

.btn { padding: 10px 20px; border-radius: var(--radius-sm); font-family: 'Sora', sans-serif; font-size: 13px; font-weight: 700; border: none; cursor: pointer; transition: all 0.15s; display: inline-flex; align-items: center; gap: 6px; }
.btn-primary { background: var(--accent); color: #1a0f00; } .btn-primary:hover { background: #f5b840; }
.btn-outline { background: transparent; border: 1px solid var(--border); color: var(--muted); } .btn-outline:hover { border-color: var(--accent); color: var(--accent); }
.btn-green { background: var(--green); color: #001a10; } .btn-green:hover { background: #4ade80; }
.btn-danger { background: transparent; border: 1px solid var(--border); color: var(--red); }
.btn-sm { padding: 6px 12px; font-size: 11px; } .btn-block { width: 100%; justify-content: center; }

.sub-tabs { display: flex; gap: 6px; margin-bottom: 16px; background: var(--surface2); border: 1px solid var(--border); border-radius: var(--radius-sm); padding: 4px; }
.sub-tab-btn { flex: 1; padding: 9px 8px; border: none; border-radius: 6px; background: none; font-family: 'Sora', sans-serif; font-weight: 600; font-size: 12px; color: var(--muted); cursor: pointer; transition: all 0.2s; white-space: nowrap; }
.sub-tab-btn.active { background: var(--surface); color: var(--accent); border: 1px solid var(--border); }

.vendor-item { display: flex; align-items: center; gap: 12px; padding: 13px 15px; border-radius: var(--radius-sm); border: 1px solid var(--border); margin-bottom: 10px; background: var(--surface2); transition: border-color 0.2s; }
.vendor-item:hover { border-color: rgba(245,166,35,0.3); }
.vendor-avatar { width: 40px; height: 40px; border-radius: 10px; background: linear-gradient(135deg, var(--accent), #c47a10); display: flex; align-items: center; justify-content: center; font-weight: 800; font-size: 16px; color: #1a0f00; flex-shrink: 0; }
.vendor-info { flex: 1; } .vendor-name { font-weight: 700; font-size: 14px; }
.vendor-meta { font-size: 11px; color: var(--muted); margin-top: 3px; display: flex; gap: 10px; flex-wrap: wrap; }
.rate-tag { display: inline-flex; align-items: center; gap: 3px; padding: 2px 8px; border-radius: 20px; font-size: 10px; font-weight: 700; }
.rate-cow { background: rgba(245,166,35,0.15); color: var(--cow); border: 1px solid rgba(245,166,35,0.3); }
.rate-buffalo { background: rgba(96,165,250,0.15); color: var(--buffalo); border: 1px solid rgba(96,165,250,0.3); }

.session-toggle { display: flex; background: var(--surface2); border: 1px solid var(--border); border-radius: var(--radius-sm); padding: 4px; margin-bottom: 16px; gap: 4px; }
.sess-btn { flex: 1; padding: 9px; border: none; border-radius: 6px; background: none; font-family: 'Sora', sans-serif; font-weight: 600; font-size: 13px; color: var(--muted); cursor: pointer; transition: all 0.2s; }
.sess-btn.morning.active { background: rgba(251,191,36,0.15); color: var(--morning); }
.sess-btn.evening.active { background: rgba(129,140,248,0.15); color: var(--evening); }

.vendor-entry { background: var(--surface2); border: 1px solid var(--border); border-radius: var(--radius-sm); padding: 13px 15px; margin-bottom: 10px; }
.vendor-entry.locked { border-color: rgba(52,211,153,0.25); }
.vendor-entry-header { font-weight: 700; font-size: 14px; margin-bottom: 10px; display: flex; align-items: center; gap: 8px; }
.entry-fields { display: flex; gap: 10px; flex-wrap: wrap; }
.entry-field { flex: 1; min-width: 100px; }
.entry-field label { font-size: 10px; }
.milk-input-wrap { position: relative; }
.milk-input-wrap input { padding-right: 28px; }
.milk-unit { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); font-size: 11px; color: var(--muted); pointer-events: none; }
.saved-val { padding: 10px 12px; background: rgba(52,211,153,0.08); border: 1px solid rgba(52,211,153,0.2); border-radius: var(--radius-sm); font-size: 13px; font-weight: 700; color: var(--green); }
.locked-badge { font-size: 10px; background: rgba(52,211,153,0.1); color: var(--green); border: 1px solid rgba(52,211,153,0.2); padding: 2px 8px; border-radius: 20px; margin-left: auto; }

.cycle-badge { display: inline-flex; align-items: center; gap: 6px; padding: 5px 12px; border-radius: 20px; background: rgba(245,166,35,0.1); border: 1px solid rgba(245,166,35,0.3); color: var(--accent); font-size: 12px; font-weight: 700; margin-bottom: 16px; }

.payment-card { background: var(--surface2); border: 1px solid var(--border); border-radius: var(--radius-sm); margin-bottom: 12px; overflow: hidden; }
.payment-header { padding: 13px 15px; display: flex; align-items: center; gap: 12px; cursor: pointer; transition: background 0.15s; }
.payment-header:hover { background: rgba(255,255,255,0.02); }
.payment-body { padding: 0 15px 15px; border-top: 1px solid var(--border); }
.payment-stat { display: flex; justify-content: space-between; padding: 6px 0; font-size: 13px; border-bottom: 1px solid rgba(255,255,255,0.04); }
.payment-stat:last-child { border-bottom: none; }
.payment-stat .lbl { color: var(--muted); } .payment-stat .val { font-weight: 600; }
.amount-big { font-size: 22px; font-weight: 800; color: var(--accent); }
.paid-tag { color: var(--green); font-size: 11px; font-weight: 700; }
.pending-tag { color: var(--morning); font-size: 11px; font-weight: 700; }

.stats-row { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 14px; }
.stat-box { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius-sm); padding: 14px; }
.stat-num { font-size: 24px; font-weight: 800; }
.stat-num.accent { color: var(--accent); } .stat-num.green { color: var(--green); }
.stat-num.blue { color: var(--blue); } .stat-num.purple { color: var(--purple); }
.stat-label { font-size: 11px; color: var(--muted); margin-top: 3px; }

.data-table { width: 100%; border-collapse: collapse; font-size: 12px; }
.data-table th { text-align: left; padding: 8px 10px; font-size: 10px; text-transform: uppercase; letter-spacing: 0.5px; color: var(--muted); border-bottom: 1px solid var(--border); font-weight: 600; }
.data-table td { padding: 9px 10px; border-bottom: 1px solid rgba(255,255,255,0.04); }
.data-table tr:last-child td { border-bottom: none; }
.data-table tr:hover td { background: rgba(255,255,255,0.02); }

.badge { display: inline-flex; align-items: center; gap: 3px; padding: 2px 8px; border-radius: 20px; font-size: 10px; font-weight: 700; }
.badge-morning { background: rgba(251,191,36,0.15); color: var(--morning); }
.badge-evening { background: rgba(129,140,248,0.15); color: var(--evening); }

.modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.75); z-index: 500; display: flex; align-items: center; justify-content: center; padding: 16px; }
.modal { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); padding: 22px; width: 100%; max-width: 440px; max-height: 90vh; overflow-y: auto; }
.modal h3 { font-size: 16px; font-weight: 800; margin-bottom: 16px; }
.modal-actions { display: flex; gap: 10px; margin-top: 16px; }

.toast { position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%) translateY(80px); background: var(--surface2); border: 1px solid var(--border); padding: 10px 20px; border-radius: 30px; font-size: 13px; font-weight: 600; z-index: 9998; transition: transform 0.3s ease; white-space: nowrap; pointer-events: none; }
.toast.show { transform: translateX(-50%) translateY(0); }
.toast.success { border-color: var(--green); color: var(--green); }
.toast.error { border-color: var(--red); color: var(--red); }

.setup-panel { background: rgba(245,166,35,0.06); border: 1px solid rgba(245,166,35,0.25); border-radius: var(--radius); padding: 18px; margin-bottom: 14px; }
.step { display: flex; gap: 12px; margin-bottom: 10px; }
.step-num { width: 22px; height: 22px; background: var(--accent); color: #1a0f00; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: 800; flex-shrink: 0; margin-top: 1px; }
.step-text { font-size: 13px; color: var(--muted); line-height: 1.5; }
.step-text strong { color: var(--text); }
code { background: var(--surface2); border: 1px solid var(--border); padding: 2px 6px; border-radius: 4px; font-size: 11px; font-family: monospace; color: var(--accent); }
.divider { height: 1px; background: var(--border); margin: 14px 0; }
.empty { text-align: center; padding: 36px 20px; color: var(--muted); }
.empty .ico { font-size: 36px; margin-bottom: 10px; }
.empty p { font-size: 13px; }
.spinner { display: inline-block; width: 14px; height: 14px; border: 2px solid rgba(255,255,255,0.2); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.7s linear infinite; }
.hidden { display: none !important; }

.report-summary-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 14px; }
.report-stat { background: var(--surface2); border: 1px solid var(--border); border-radius: var(--radius-sm); padding: 12px; text-align: center; }
.report-stat .rnum { font-size: 20px; font-weight: 800; }
.report-stat .rlbl { font-size: 10px; color: var(--muted); margin-top: 3px; }
.day-row { display: flex; align-items: center; border-bottom: 1px solid rgba(255,255,255,0.04); padding: 8px 10px; font-size: 12px; }
.day-row:last-child { border-bottom: none; }
.day-col { flex: 1; }
.day-col.dc-date { font-weight: 600; min-width: 80px; }
.day-col.dc-num { text-align: right; }
.day-col.dc-amt { text-align: right; font-weight: 700; color: var(--accent); }
.sub-hdr { display: flex; padding: 6px 10px; font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; color: var(--muted); border-bottom: 1px solid var(--border); background: var(--surface2); border-radius: 6px 6px 0 0; }
.sub-hdr .day-col.dc-num, .sub-hdr .day-col.dc-amt { text-align: right; }

.sec-item { display: flex; gap: 12px; align-items: flex-start; padding: 12px 0; border-bottom: 1px solid rgba(255,255,255,0.05); }
.sec-item:last-child { border-bottom: none; }
.sec-icon { font-size: 20px; flex-shrink: 0; margin-top: 2px; }
.sec-text strong { color: var(--text); display: block; margin-bottom: 3px; font-size: 14px; }
.sec-text span { color: var(--muted); font-size: 12px; line-height: 1.5; }

/* ROLE */
.role-btn { display:flex; align-items:center; gap:14px; width:100%; padding:14px 18px; border-radius:var(--radius-sm); border:1px solid var(--border); background:var(--surface2); color:var(--text); font-family:'Sora',sans-serif; cursor:pointer; transition:all 0.2s; text-align:left; }
.role-btn:hover { border-color:var(--accent); background:rgba(245,166,35,0.08); }
.role-badge { display:inline-flex; align-items:center; gap:5px; padding:3px 10px; border-radius:20px; font-size:11px; font-weight:700; }
.role-manager { background:rgba(245,166,35,0.15); color:var(--accent); border:1px solid rgba(245,166,35,0.3); }
.role-operator { background:rgba(96,165,250,0.15); color:var(--blue); border:1px solid rgba(96,165,250,0.3); }

/* OUTSTANDING */
.os-card { background:var(--surface2); border:1px solid var(--border); border-radius:var(--radius-sm); margin-bottom:10px; overflow:hidden; }
.os-header { display:flex; align-items:center; gap:12px; padding:13px 15px; cursor:pointer; }
.os-header:hover { background:rgba(255,255,255,0.02); }
.os-debit { color:var(--morning); } /* we owe vendor */
.os-credit { color:var(--green); }  /* vendor overpaid / advance */
.os-zero { color:var(--muted); }
.os-body { padding:0 15px 14px; border-top:1px solid var(--border); }
.ledger-row { display:flex; justify-content:space-between; align-items:center; padding:7px 0; border-bottom:1px solid rgba(255,255,255,0.04); font-size:12px; }
.ledger-row:last-child { border-bottom:none; }
.ledger-cycle { font-weight:700; font-size:11px; color:var(--muted); }
.ledger-val { font-weight:700; text-align:right; }
.ledger-total-row { display:flex; justify-content:space-between; align-items:center; padding:9px 12px; background:rgba(245,166,35,0.06); border-top:2px solid var(--border); font-size:13px; font-weight:800; border-radius:0 0 var(--radius-sm) var(--radius-sm); }
.summary-grid { display:grid; grid-template-columns:repeat(3,1fr); gap:8px; margin-bottom:14px; }
.summary-box { background:var(--surface2); border:1px solid var(--border); border-radius:var(--radius-sm); padding:12px; text-align:center; }
.summary-box .snum { font-size:18px; font-weight:800; }
.summary-box .slbl { font-size:10px; color:var(--muted); margin-top:3px; }
</style>
</head>
<body>

<!-- LOGIN -->
<div id="login-screen">
  <div class="login-box">
    <div class="login-logo">üêÑ</div>
    <h2>Yogesh Dairy</h2>

    <!-- Step 1: Role Selection -->
    <div id="role-step">
      <p style="font-size:13px;color:var(--muted);margin-bottom:20px;">Select your role to continue</p>
      <div style="display:flex;flex-direction:column;gap:10px;max-width:240px;margin:0 auto;">
        <button class="role-btn" onclick="selectRole('manager')">
          <span style="font-size:22px;">üëî</span>
          <div><div style="font-weight:800;font-size:15px;">Manager</div><div style="font-size:11px;opacity:0.7;">Full access</div></div>
        </button>
        <button class="role-btn" onclick="selectRole('operator')">
          <span style="font-size:22px;">üë∑</span>
          <div><div style="font-weight:800;font-size:15px;">Operator</div><div style="font-size:11px;opacity:0.7;">Collection entry only</div></div>
        </button>
      </div>
    </div>

    <!-- Step 2: PIN Entry -->
    <div id="pin-step" class="hidden">
      <p id="login-sub" style="font-size:13px;color:var(--muted);margin-bottom:20px;"></p>
      <div class="pin-dots">
        <div class="pin-dot" id="d0"></div><div class="pin-dot" id="d1"></div>
        <div class="pin-dot" id="d2"></div><div class="pin-dot" id="d3"></div>
      </div>
      <div class="pin-keypad">
        <button class="pin-key" onclick="pp('1')">1</button>
        <button class="pin-key" onclick="pp('2')">2</button>
        <button class="pin-key" onclick="pp('3')">3</button>
        <button class="pin-key" onclick="pp('4')">4</button>
        <button class="pin-key" onclick="pp('5')">5</button>
        <button class="pin-key" onclick="pp('6')">6</button>
        <button class="pin-key" onclick="pp('7')">7</button>
        <button class="pin-key" onclick="pp('8')">8</button>
        <button class="pin-key" onclick="pp('9')">9</button>
        <button class="pin-key zero" onclick="pp('0')">0</button>
        <button class="pin-key del" onclick="pd()">‚å´</button>
      </div>
      <div class="pin-error" id="pin-err"></div>
      <button onclick="backToRoles()" style="margin-top:14px;background:none;border:none;color:var(--muted);font-size:12px;cursor:pointer;font-family:'Sora',sans-serif;">‚Üê Back</button>
    </div>
  </div>
</div>

<!-- APP -->
<div id="app" class="hidden">
<header>
  <div class="header-left">
    <div class="logo-box">üêÑ</div>
    <div><h1>Yogesh Dairy</h1><p id="hdate"></p></div>
    <span id="role-badge" class="role-badge role-manager" style="margin-left:4px;">üëî Manager</span>
  </div>
  <div class="header-actions">
    <button class="sync-btn" id="sync-btn" onclick="openSettings()">
      <div class="sync-dot" id="sync-dot"></div>
      <span id="sync-lbl">Setup Sync</span>
    </button>
    <button class="lock-btn" onclick="lockApp()" title="Lock App">üîí</button>
  </div>
</header>

<div class="tabs">
  <button class="tab-btn active" id="tab-btn-dashboard" onclick="switchTab('dashboard',this)">üìä Dashboard</button>
  <button class="tab-btn" id="tab-btn-vendors" onclick="switchTab('vendors',this)">üë®‚Äçüåæ Vendors</button>
  <button class="tab-btn" id="tab-btn-collection" onclick="switchTab('collection',this)">ü•õ Collection</button>
  <button class="tab-btn" id="tab-btn-payments" onclick="switchTab('payments',this)">üí∞ Payments</button>
  <button class="tab-btn" id="tab-btn-records" onclick="switchTab('records',this)">üìã Records</button>
  <button class="tab-btn" id="tab-btn-security" onclick="switchTab('security',this)">üîê Security</button>
</div>

<main>

<!-- DASHBOARD -->
<div class="section active" id="tab-dashboard">
  <div id="dash-content"><div class="loading-screen"><div class="spinner-big"></div><p>Loading data from Google Sheets...</p></div></div>
</div>

<!-- VENDORS -->
<div class="section" id="tab-vendors">
  <div class="sub-tabs">
    <button class="sub-tab-btn active" id="vs-list-btn" onclick="vSub('list')">üë®‚Äçüåæ List</button>
    <button class="sub-tab-btn" id="vs-add-btn" onclick="vSub('add')">‚ûï Add</button>
    <button class="sub-tab-btn" id="vs-report-btn" onclick="vSub('report')">üìä Report</button>
    <button class="sub-tab-btn" id="vs-outstanding-btn" onclick="vSub('outstanding')">‚öñÔ∏è Outstanding</button>
  </div>
  <div id="vs-list">
    <div class="card">
      <div class="card-title"><span>üë®‚Äçüåæ</span> Vendor List <span style="font-size:12px;color:var(--muted);font-weight:400;" id="vcount"></span></div>
      <div id="vlist"><div class="loading-screen" style="padding:24px"><div class="spinner-big"></div><p>Loading...</p></div></div>
    </div>
  </div>
  <div id="vs-add" class="hidden">
    <div class="card">
      <div class="card-title"><span>‚ûï</span> Add New Vendor</div>
      <div class="form-row">
        <div class="form-group"><label>Vendor Name *</label><input type="text" id="vn" placeholder="e.g. Ramesh Patel"></div>
        <div class="form-group"><label>Phone</label><input type="tel" id="vph" placeholder="9876543210"></div>
      </div>
      <div class="form-row">
        <div class="form-group"><label>üêÑ Cow Rate (‚Çπ/L)</label><input type="number" id="vcr" placeholder="55" min="0" step="0.5"></div>
        <div class="form-group"><label>üêÉ Buffalo Rate (‚Çπ/L)</label><input type="number" id="vbr" placeholder="70" min="0" step="0.5"></div>
      </div>
      <div class="form-row">
        <div class="form-group"><label>Address</label><input type="text" id="vadr" placeholder="Village / Area"></div>
      </div>
      <button class="btn btn-primary" onclick="addVendor()">‚ûï Add Vendor</button>
    </div>
  </div>
  <div id="vs-report" class="hidden">
    <div class="card">
      <div class="card-title"><span>üìä</span> Vendor Collection Report</div>
      <div class="form-row">
        <div class="form-group"><label>Vendor</label><select id="rv" onchange="renderReport()"><option value="">Select Vendor</option></select></div>
        <div class="form-group"><label>Month</label>
          <select id="rm" onchange="renderReport()"><option value="0">January</option><option value="1">February</option><option value="2">March</option><option value="3">April</option><option value="4">May</option><option value="5">June</option><option value="6">July</option><option value="7">August</option><option value="8">September</option><option value="9">October</option><option value="10">November</option><option value="11">December</option></select>
        </div>
        <div class="form-group"><label>Year</label><input type="number" id="ry" value="2025" onchange="renderReport()"></div>
        <div class="form-group"><label>Cycle</label>
          <select id="rc" onchange="renderReport()"><option value="0">All Cycles</option><option value="1">Cycle 1 (1‚Äì10)</option><option value="2">Cycle 2 (11‚Äì20)</option><option value="3">Cycle 3 (21‚Äìend)</option></select>
        </div>
      </div>
    </div>
    <div id="report-out"></div>
  </div>

  <!-- OUTSTANDING SECTION -->
  <div id="vs-outstanding" class="hidden">
    <div class="card">
      <div class="card-title"><span>‚öñÔ∏è</span> Outstanding Balances</div>
      <p style="font-size:12px;color:var(--muted);margin-bottom:14px;">
        Auto carry-forward: unpaid balance from previous cycles is added as opening balance. Advance payments reduce next cycle's dues.
      </p>
      <!-- View toggle -->
      <div style="display:flex;gap:6px;margin-bottom:16px;background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius-sm);padding:4px;">
        <button id="os-all-btn" class="sub-tab-btn active" onclick="osView('all')">üë• All Vendors</button>
        <button id="os-single-btn" class="sub-tab-btn" onclick="osView('single')">üë§ Per Vendor</button>
      </div>
      <!-- Filter row -->
      <div class="form-row" style="margin-bottom:0;">
        <div class="form-group"><label>Month</label>
          <select id="os-mo" onchange="renderOutstanding()"><option value="0">January</option><option value="1">February</option><option value="2">March</option><option value="3">April</option><option value="4">May</option><option value="5">June</option><option value="6">July</option><option value="7">August</option><option value="8">September</option><option value="9">October</option><option value="10">November</option><option value="11">December</option></select>
        </div>
        <div class="form-group"><label>Year</label>
          <input type="number" id="os-yr" value="2025" onchange="renderOutstanding()">
        </div>
        <div class="form-group os-single-only hidden"><label>Vendor</label>
          <select id="os-vid" onchange="renderOutstanding()"><option value="">Select Vendor</option></select>
        </div>
      </div>
    </div>
    <div id="outstanding-out"></div>
  </div>
</div>

<!-- COLLECTION -->
<div class="section" id="tab-collection">

  <!-- STEP 1: Date + Session -->
  <div class="card" id="coll-step1">
    <div class="card-title"><span>1Ô∏è‚É£</span> Select Date & Session</div>
    <div class="form-row" style="align-items:flex-end;margin-bottom:16px;">
      <div class="form-group" style="max-width:180px;"><label>Date</label><input type="date" id="col-date" onchange="collDateChanged()"></div>
      <div id="col-cycle" class="cycle-badge" style="margin-bottom:0;">üìÖ Cycle</div>
    </div>
    <div class="session-toggle">
      <button class="sess-btn morning" id="sess-m" onclick="collSelectSess('morning')">‚òÄÔ∏è Morning</button>
      <button class="sess-btn evening" id="sess-e" onclick="collSelectSess('evening')">üåô Evening</button>
    </div>
  </div>

  <!-- STEP 2: Select Vendor -->
  <div class="card hidden" id="coll-step2">
    <div class="card-title">
      <span>2Ô∏è‚É£</span> Select Vendor
      <span id="coll-sess-badge" style="margin-left:auto;font-size:12px;font-weight:600;"></span>
    </div>
    <div id="coll-vendor-list"></div>
  </div>

  <!-- STEP 3: Enter Qty -->
  <div class="card hidden" id="coll-step3">
    <div class="card-title">
      <span>3Ô∏è‚É£</span> Enter Milk Quantity
      <button onclick="collBack()" style="margin-left:auto;background:none;border:none;color:var(--muted);font-size:12px;cursor:pointer;font-family:'Sora',sans-serif;">‚Üê Back</button>
    </div>
    <div id="coll-vendor-info" style="background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius-sm);padding:12px;margin-bottom:16px;display:flex;align-items:center;gap:12px;">
    </div>
    <div class="form-row">
      <div class="form-group">
        <label>üêÑ Cow Milk (Litres)</label>
        <div class="milk-input-wrap">
          <input type="number" id="coll-cow" min="0" step="0.1" placeholder="0.0" oninput="collCalcAmt()">
          <span class="milk-unit">L</span>
        </div>
      </div>
      <div class="form-group">
        <label>üêÉ Buffalo Milk (Litres)</label>
        <div class="milk-input-wrap">
          <input type="number" id="coll-buf" min="0" step="0.1" placeholder="0.0" oninput="collCalcAmt()">
          <span class="milk-unit">L</span>
        </div>
      </div>
    </div>
    <div id="coll-amt-preview" style="background:rgba(245,166,35,0.08);border:1px solid rgba(245,166,35,0.25);border-radius:var(--radius-sm);padding:12px 16px;margin-bottom:16px;font-size:15px;font-weight:800;color:var(--accent);display:none;"></div>
    <button class="btn btn-green btn-block" onclick="collSubmit()">üíæ Save Entry</button>
  </div>

  <!-- Today's entries for this session -->
  <div id="coll-done-list"></div>

</div>

<!-- PAYMENTS -->
<div class="section" id="tab-payments">
  <div class="card">
    <div class="card-title"><span>üóìÔ∏è</span> Select Cycle</div>
    <div class="form-row">
      <div class="form-group"><label>Month</label>
        <select id="pm" onchange="renderPay()"><option value="0">January</option><option value="1">February</option><option value="2">March</option><option value="3">April</option><option value="4">May</option><option value="5">June</option><option value="6">July</option><option value="7">August</option><option value="8">September</option><option value="9">October</option><option value="10">November</option><option value="11">December</option></select>
      </div>
      <div class="form-group"><label>Year</label><input type="number" id="py" value="2025" onchange="renderPay()"></div>
      <div class="form-group"><label>Cycle</label>
        <select id="pc" onchange="renderPay()"><option value="1">Cycle 1 (1‚Äì10)</option><option value="2">Cycle 2 (11‚Äì20)</option><option value="3">Cycle 3 (21‚Äìend)</option></select>
      </div>
    </div>
  </div>
  <div id="pay-list"></div>
</div>

<!-- RECORDS -->
<div class="section" id="tab-records">
  <div class="card">
    <div class="card-title"><span>üìã</span> Collection Records</div>
    <div class="form-row" style="margin-bottom:12px;">
      <div class="form-group"><label>Vendor</label><select id="rec-v" onchange="renderRec()"><option value="">All Vendors</option></select></div>
      <div class="form-group"><label>Session</label><select id="rec-s" onchange="renderRec()"><option value="">Both</option><option value="morning">Morning</option><option value="evening">Evening</option></select></div>
    </div>
    <div id="rec-wrap"><div class="empty"><div class="ico">üì≠</div><p>No records yet.</p></div></div>
  </div>
</div>

<!-- SECURITY -->
<div class="section" id="tab-security">
  <div class="card">
    <div class="card-title"><span>üîê</span> Security Overview</div>
    <div class="sec-item"><div class="sec-icon">üîë</div><div class="sec-text"><strong>PIN Lock</strong><span>App is locked with a 4-digit PIN. Auto-locks after 5 minutes of inactivity.</span></div></div>
    <div class="sec-item"><div class="sec-icon">‚òÅÔ∏è</div><div class="sec-text"><strong>Google Sheets as Database</strong><span>All data lives only in your Google Sheet. Nothing is stored permanently on this device.</span></div></div>
    <div class="sec-item"><div class="sec-icon">üîí</div><div class="sec-text"><strong>No Edit / No Delete</strong><span>Collection entries cannot be edited or deleted once saved ‚Äî prevents accidental data tampering.</span></div></div>
    <div class="sec-item"><div class="sec-icon">‚úèÔ∏è</div><div class="sec-text"><strong>Rate-Only Updates</strong><span>Only milk rates (‚Çπ/L) can be updated on vendor profiles, as rates change each 10-day cycle.</span></div></div>
    <div class="sec-item"><div class="sec-icon">üì±</div><div class="sec-text"><strong>Multi-Device Access</strong><span>Open on any phone or computer ‚Äî always fetches fresh data from Google Sheets on every login.</span></div></div>
    <div class="sec-item"><div class="sec-icon">üë•</div><div class="sec-text"><strong>Two Roles</strong><span>Manager: full access. Operator: collection entry only. Each has a separate PIN.<div id="sec-pin-info"></div></span></div></div>
  </div>
  <div class="card">
    <div class="card-title"><span>üîë</span> Change Manager PIN</div>
    <p style="font-size:12px;color:var(--muted);margin-bottom:14px;">Default: 1234</p>
    <div class="form-row">
      <div class="form-group"><label>Current PIN</label><input type="password" id="op" maxlength="4" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" inputmode="numeric"></div>
      <div class="form-group"><label>New PIN</label><input type="password" id="np" maxlength="4" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" inputmode="numeric"></div>
      <div class="form-group"><label>Confirm PIN</label><input type="password" id="cp" maxlength="4" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" inputmode="numeric"></div>
    </div>
    <button class="btn btn-primary" onclick="changePin()">üîë Update Manager PIN</button>
  </div>
  <div class="card">
    <div class="card-title"><span>üë∑</span> Change Operator PIN</div>
    <p style="font-size:12px;color:var(--muted);margin-bottom:14px;">Default: 5678 ‚Äî Operator can only enter milk collection</p>
    <div class="form-row">
      <div class="form-group"><label>Manager PIN (to authorize)</label><input type="password" id="op-auth" maxlength="4" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" inputmode="numeric"></div>
      <div class="form-group"><label>New Operator PIN</label><input type="password" id="op-np" maxlength="4" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" inputmode="numeric"></div>
      <div class="form-group"><label>Confirm PIN</label><input type="password" id="op-cp" maxlength="4" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" inputmode="numeric"></div>
    </div>
    <button class="btn btn-primary" onclick="changeOperatorPin()">üîë Update Operator PIN</button>
  </div>
  <div class="card">
    <div class="card-title"><span>‚òÅÔ∏è</span> Sheet Connection</div>
    <div id="sec-sheet-status" style="font-size:13px;margin-bottom:12px;"></div>
    <button class="btn btn-outline" onclick="openSettings()">‚öôÔ∏è Manage Connection</button>
  </div>
</div>

</main>
</div>

<!-- SETTINGS MODAL -->
<div class="modal-overlay hidden" id="settings-modal" onclick="if(event.target===this)closeSettings()">
  <div class="modal">
    <h3>‚öôÔ∏è Google Sheets Sync</h3>
    <div class="setup-panel">
      <strong style="font-size:13px;">One-time setup:</strong>
      <div style="margin-top:12px;">
        <div class="step"><div class="step-num">1</div><div class="step-text">Create a new Google Sheet named <strong>"Yogesh Dairy"</strong></div></div>
        <div class="step"><div class="step-num">2</div><div class="step-text">Go to <strong>Extensions ‚Üí Apps Script</strong>, paste the provided script, save</div></div>
        <div class="step"><div class="step-num">3</div><div class="step-text"><strong>Deploy ‚Üí New deployment ‚Üí Web app</strong>, set access to <code>Anyone</code>, copy the URL</div></div>
        <div class="step"><div class="step-num">4</div><div class="step-text">Paste URL below and click Connect</div></div>
      </div>
    </div>
    <div class="form-group" style="margin-bottom:12px;">
      <label>Apps Script Web App URL</label>
      <input type="url" id="sheet-url" placeholder="https://script.google.com/macros/s/...">
    </div>
    <div class="modal-actions">
      <button class="btn btn-primary" style="flex:1;" id="conn-btn" onclick="connectSheet()">üîó Connect & Load Data</button>
      <button class="btn btn-outline" onclick="closeSettings()">Cancel</button>
    </div>
    <div id="conn-status" style="margin-top:10px;font-size:12px;color:var(--muted);"></div>
    <div class="divider"></div>
    <div style="display:flex;gap:10px;flex-wrap:wrap;">
      <button class="btn btn-outline btn-sm" onclick="pullFromSheet()">üîÑ Refresh All Data</button>
      <button class="btn btn-danger btn-sm" onclick="disconnectSheet()">‚úï Disconnect</button>
    </div>
  </div>
</div>

<!-- RATE EDIT MODAL -->
<div class="modal-overlay hidden" id="rate-modal" onclick="if(event.target===this)closeRate()">
  <div class="modal">
    <h3>‚úèÔ∏è Update Milk Rates</h3>
    <p style="font-size:12px;color:var(--muted);margin-bottom:16px;">Only milk rates can be updated. Name, phone and address are permanent.</p>
    <input type="hidden" id="rate-id">
    <div style="background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius-sm);padding:12px;margin-bottom:14px;">
      <div id="rate-vname" style="font-weight:700;font-size:15px;"></div>
      <div id="rate-vmeta" style="font-size:12px;color:var(--muted);margin-top:3px;"></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label>üêÑ Cow Rate (‚Çπ/L)</label><input type="number" id="rate-cr" step="0.5" min="0"></div>
      <div class="form-group"><label>üêÉ Buffalo Rate (‚Çπ/L)</label><input type="number" id="rate-br" step="0.5" min="0"></div>
    </div>
    <div class="modal-actions">
      <button class="btn btn-primary" style="flex:1;" onclick="saveRates()">üíæ Save Rates</button>
      <button class="btn btn-outline" onclick="closeRate()">Cancel</button>
    </div>
  </div>
</div>

<!-- PAYMENT MODAL -->
<div class="modal-overlay hidden" id="pay-modal" onclick="if(event.target===this)closePay()">
  <div class="modal">
    <h3>üí≥ Record Payment</h3>
    <div id="pay-info" style="margin-bottom:14px;font-size:13px;color:var(--muted);"></div>
    <input type="hidden" id="pay-vid">
    <div class="form-group" style="margin-bottom:8px;"><label>Gross Amount Due</label><div id="pay-due" style="font-size:22px;font-weight:800;color:var(--accent);padding:4px 0;"></div></div>
    <div class="form-group" style="margin-bottom:12px;"><label>Amount Paid (‚Çπ)</label><input type="number" id="pay-amt" step="0.5"></div>
    <div class="form-group" style="margin-bottom:12px;"><label>Payment Mode</label>
      <select id="pay-mode"><option>Cash</option><option>UPI</option><option>Bank Transfer</option><option>Cheque</option></select>
    </div>
    <div class="modal-actions">
      <button class="btn btn-green" style="flex:1;" onclick="confirmPay()">‚úÖ Confirm Payment</button>
      <button class="btn btn-outline" onclick="closePay()">Cancel</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// =========================================================
// STATE ‚Äî no localStorage for business data
// =========================================================
let V = [], C = [], P = []; // vendors, collections, payments
let sheetUrl = localStorage.getItem('yd_url') || '';
let sess = 'morning';
let payData = null;
let lockTimer = null;
const LOCK_TIME = 5 * 60 * 1000;

// =========================================================
// ROLES & PIN
// =========================================================
let pinBuf = '';
let currentRole = ''; // 'manager' or 'operator'

function getMgrPin() { return localStorage.getItem('yd_pin') || '9670'; }
function getOpPin()  { return localStorage.getItem('yd_op_pin') || '1234'; }

// OPERATOR permissions: which tabs are allowed
const OP_TABS = ['dashboard', 'vendors', 'collection', 'records'];
const OP_VENDOR_SUBS = ['list', 'report']; // no 'add'

function initLogin() {
  // Show role step, hide pin step
  document.getElementById('role-step').classList.remove('hidden');
  document.getElementById('pin-step').classList.add('hidden');
  pinBuf = ''; updateDots();
  document.getElementById('pin-err').textContent = '';
  currentRole = '';
}

function selectRole(role) {
  currentRole = role;
  document.getElementById('role-step').classList.add('hidden');
  document.getElementById('pin-step').classList.remove('hidden');
  document.getElementById('login-sub').textContent =
    role === 'manager' ? 'üëî Manager PIN' : 'üë∑ Operator PIN';
  pinBuf = ''; updateDots();
  document.getElementById('pin-err').textContent = '';
}

function backToRoles() {
  document.getElementById('pin-step').classList.add('hidden');
  document.getElementById('role-step').classList.remove('hidden');
  pinBuf = ''; updateDots();
  currentRole = '';
}

function pp(d) {
  if (pinBuf.length >= 4) return;
  pinBuf += d; updateDots();
  if (pinBuf.length === 4) setTimeout(checkPin, 120);
}
function pd() { pinBuf = pinBuf.slice(0,-1); updateDots(); document.getElementById('pin-err').textContent = ''; }
function updateDots() { for(let i=0;i<4;i++) document.getElementById('d'+i).classList.toggle('filled', i < pinBuf.length); }

function checkPin() {
  const correctPin = currentRole === 'manager' ? getMgrPin() : getOpPin();
  if (pinBuf === correctPin) {
    document.getElementById('login-screen').classList.add('hidden');
    document.getElementById('app').classList.remove('hidden');
    applyRoleUI();
    initApp();
    resetLock();
  } else {
    document.getElementById('pin-err').textContent = '‚ùå Wrong PIN. Try again.';
    pinBuf = ''; updateDots();
  }
}

function applyRoleUI() {
  const isMgr = currentRole === 'manager';
  // Update role badge in header
  const badge = document.getElementById('role-badge');
  badge.className = 'role-badge ' + (isMgr ? 'role-manager' : 'role-operator');
  badge.textContent = isMgr ? 'üëî Manager' : 'üë∑ Operator';

  // Show/hide tabs based on role
  const hiddenTabs = isMgr ? [] : ['payments', 'security'];
  ['dashboard','vendors','collection','payments','records','security'].forEach(t => {
    const btn = document.getElementById('tab-btn-' + t);
    if (btn) btn.style.display = hiddenTabs.includes(t) ? 'none' : '';
  });

  // Show/hide Add Vendor sub-tab for operator
  const addBtn = document.getElementById('vs-add-btn');
  if (addBtn) addBtn.style.display = isMgr ? '' : 'none';
}

function lockApp() {
  document.getElementById('app').classList.add('hidden');
  document.getElementById('login-screen').classList.remove('hidden');
  V = []; C = []; P = [];
  clearTimeout(lockTimer);
  initLogin();
}

function resetLock() {
  clearTimeout(lockTimer);
  lockTimer = setTimeout(lockApp, LOCK_TIME);
}
document.addEventListener('click', resetLock);
document.addEventListener('touchstart', resetLock);

function changePin() {
  const op = document.getElementById('op').value;
  const np = document.getElementById('np').value;
  const cp2 = document.getElementById('cp').value;
  if (op !== getMgrPin()) { toast('Current Manager PIN incorrect', 'error'); return; }
  if (!/^\d{4}$/.test(np)) { toast('PIN must be 4 digits', 'error'); return; }
  if (np !== cp2) { toast('PINs do not match', 'error'); return; }
  localStorage.setItem('yd_pin', np);
  ['op','np','cp'].forEach(id => document.getElementById(id).value = '');
  toast('‚úÖ Manager PIN updated!');
}

function changeOperatorPin() {
  const auth = document.getElementById('op-auth').value;
  const np   = document.getElementById('op-np').value;
  const cp2  = document.getElementById('op-cp').value;
  if (auth !== getMgrPin()) { toast('Manager PIN incorrect', 'error'); return; }
  if (!/^\d{4}$/.test(np)) { toast('PIN must be 4 digits', 'error'); return; }
  if (np !== cp2) { toast('PINs do not match', 'error'); return; }
  if (np === getMgrPin()) { toast('Operator PIN cannot be same as Manager PIN', 'error'); return; }
  localStorage.setItem('yd_op_pin', np);
  ['op-auth','op-np','op-cp'].forEach(id => document.getElementById(id).value = '');
  toast('‚úÖ Operator PIN updated!');
}

// =========================================================
// INIT
// =========================================================
async function initApp() {
  const now = new Date();
  const DAYS = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
  const MONTHS = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  document.getElementById('hdate').textContent = `${DAYS[now.getDay()]}, ${now.getDate()} ${MONTHS[now.getMonth()]} ${now.getFullYear()}`;
  document.getElementById('pm').value = now.getMonth();
  document.getElementById('py').value = now.getFullYear();
  document.getElementById('pc').value = cycleFor(toDay());
  document.getElementById('rm').value = now.getMonth();
  document.getElementById('ry').value = now.getFullYear();
  document.getElementById('rc').value = cycleFor(toDay());
  updateSyncUI();
  if (!sheetUrl) { showNoSheetScreen(); }
  else { showLoadingScreen(); await pull(true); }
}

function showLoadingScreen() {
  document.getElementById('dash-content').innerHTML = '<div class="loading-screen"><div class="spinner-big"></div><p>Loading data from Google Sheets...</p></div>';
  const vl = document.getElementById('vlist');
  if (vl) vl.innerHTML = '<div class="loading-screen" style="padding:24px"><div class="spinner-big"></div><p>Loading...</p></div>';
}

function showNoSheetScreen() {
  const html = `<div style="text-align:center;padding:40px 20px;"><div style="font-size:48px;margin-bottom:16px;">üîó</div><div style="font-size:18px;font-weight:800;margin-bottom:8px;">Google Sheets Not Connected</div><div style="font-size:13px;color:var(--muted);margin-bottom:24px;line-height:1.6;">This app requires Google Sheets to work.<br>All your data is stored securely in your sheet.</div><button class="btn btn-primary" onclick="openSettings()">‚öôÔ∏è Setup Google Sheets Sync</button></div>`;
  document.getElementById('dash-content').innerHTML = html;
  const vl = document.getElementById('vlist'); if (vl) vl.innerHTML = html;
}

function showNoInternetScreen() {
  const html = `<div style="text-align:center;padding:40px 20px;"><div style="font-size:48px;margin-bottom:16px;">üìµ</div><div style="font-size:18px;font-weight:800;margin-bottom:8px;color:var(--red);">No Internet Connection</div><div style="font-size:13px;color:var(--muted);margin-bottom:24px;line-height:1.6;">This app needs internet to load your data<br>from Google Sheets.<br><br>Please check your connection and try again.</div><button class="btn btn-primary" onclick="retryLoad()">üîÑ Retry</button></div>`;
  document.getElementById('dash-content').innerHTML = html;
  const vl = document.getElementById('vlist'); if (vl) vl.innerHTML = html;
}

async function retryLoad() {
  if (!sheetUrl) { showNoSheetScreen(); return; }
  showLoadingScreen(); await pull(true);
}

// =========================================================
// UTILS
// =========================================================
function uid() { return Date.now()+'_'+Math.random().toString(36).substr(2,5); }
function toast(msg, type='success') {
  const el = document.getElementById('toast');
  el.textContent = msg; el.className = 'toast '+type+' show';
  setTimeout(() => el.className = 'toast', 2800);
}
function fmtDate(d) {
  if (!d) return '';
  const s = String(d).substring(0,10).split('-');
  if (s.length < 3) return d;
  const MN = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  return `${s[2]} ${MN[+s[1]-1]} ${s[0]}`;
}
function toDay() { return new Date().toISOString().split('T')[0]; }
function cycleFor(ds) { const d=parseInt(String(ds).split('-')[2]); return d<=10?1:d<=20?2:3; }
function cycleName(c) { return c===1?'1‚Äì10':c===2?'11‚Äì20':'21‚Äìend'; }
function cycleDates(yr, mo, cy) {
  const m = String(mo+1).padStart(2,'0');
  if (cy===1) return {s:`${yr}-${m}-01`, e:`${yr}-${m}-10`};
  if (cy===2) return {s:`${yr}-${m}-11`, e:`${yr}-${m}-20`};
  const ld = new Date(yr, mo+1, 0).getDate();
  return {s:`${yr}-${m}-21`, e:`${yr}-${m}-${String(ld).padStart(2,'0')}`};
}

// =========================================================
// TABS
// =========================================================
function switchTab(t, btn) {
  // Role enforcement
  if (currentRole === 'operator' && (t === 'payments' || t === 'security')) {
    toast('Access denied for Operator role', 'error'); return;
  }
  // Sheet enforcement
  if (!sheetUrl && t !== 'dashboard' && t !== 'security') {
    toast('Connect to Google Sheets first!', 'error'); return;
  }
  document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById('tab-'+t).classList.add('active');
  btn.classList.add('active');
  if (t==='collection') { initCollDate(); }
  if (t==='payments') renderPay();
  if (t==='records') { updRecSel(); renderRec(); }
  if (t==='dashboard') renderDash();
  if (t==='security') renderSecStatus();
  if (t==='vendors') renderVList();
}

function vSub(s) {
  if (s === 'add' && currentRole === 'operator') {
    toast('Only Manager can add vendors', 'error'); return;
  }
  ['list','add','report','outstanding'].forEach(x => {
    document.getElementById('vs-'+x).classList.toggle('hidden', x!==s);
    document.getElementById('vs-'+x+'-btn').classList.toggle('active', x===s);
  });
  if (s==='report') { updRptSel(); renderReport(); }
  if (s==='outstanding') { initOutstanding(); renderOutstanding(); }
}

// =========================================================
// VENDORS
// =========================================================
async function addVendor() {
  const name = document.getElementById('vn').value.trim();
  if (!name) { toast('Enter vendor name', 'error'); return; }
  if (!sheetUrl) { toast('Connect to Google Sheets first!', 'error'); return; }
  const vendor = {
    id: uid(), name,
    phone: document.getElementById('vph').value.trim(),
    cowRate: parseFloat(document.getElementById('vcr').value)||0,
    buffaloRate: parseFloat(document.getElementById('vbr').value)||0,
    address: document.getElementById('vadr').value.trim()
  };
  V.push(vendor); renderVList();
  const ok = await sync('addVendor', {vendor});
  if (ok) {
    toast('‚úÖ Vendor added & saved!');
    ['vn','vph','vcr','vbr','vadr'].forEach(id => document.getElementById(id).value='');
    vSub('list');
  } else {
    V = V.filter(v=>v.id!==vendor.id); renderVList();
    toast('‚ùå Failed to save vendor. Check sheet connection.', 'error');
  }
}

function openRate(id) {
  const v = V.find(x=>x.id===id); if (!v) return;
  document.getElementById('rate-id').value = v.id;
  document.getElementById('rate-vname').textContent = v.name;
  document.getElementById('rate-vmeta').textContent = (v.phone?'üìû '+v.phone:'')+(v.address?' ¬∑ üìç'+v.address:'');
  document.getElementById('rate-cr').value = v.cowRate||'';
  document.getElementById('rate-br').value = v.buffaloRate||'';
  document.getElementById('rate-modal').classList.remove('hidden');
}
function closeRate() { document.getElementById('rate-modal').classList.add('hidden'); }

async function saveRates() {
  const id = document.getElementById('rate-id').value;
  const idx = V.findIndex(v=>v.id===id); if (idx<0) return;
  const prev = {...V[idx]};
  V[idx] = {...V[idx], cowRate: parseFloat(document.getElementById('rate-cr').value)||0, buffaloRate: parseFloat(document.getElementById('rate-br').value)||0};
  closeRate(); renderVList();
  const ok = await sync('updateVendor', {vendor: V[idx]});
  if (ok) { toast('‚úÖ Rates updated!'); }
  else { V[idx] = prev; renderVList(); toast('‚ùå Failed to update rates', 'error'); }
}

function renderVList() {
  const el = document.getElementById('vlist');
  document.getElementById('vcount').textContent = V.length ? `(${V.length})` : '';
  if (!V.length) { el.innerHTML = '<div class="empty"><div class="ico">üë§</div><p>No vendors yet.</p></div>'; return; }
  el.innerHTML = V.map(v => `
    <div class="vendor-item">
      <div class="vendor-avatar">${v.name[0].toUpperCase()}</div>
      <div class="vendor-info">
        <div class="vendor-name">${v.name}</div>
        <div class="vendor-meta">${v.phone?`<span>üìû ${v.phone}</span>`:''}${v.address?`<span>üìç ${v.address}</span>`:''}</div>
        <div style="margin-top:5px;display:flex;gap:6px;">
          <span class="rate-tag rate-cow">üêÑ ‚Çπ${v.cowRate}/L</span>
          <span class="rate-tag rate-buffalo">üêÉ ‚Çπ${v.buffaloRate}/L</span>
        </div>
      </div>
      ${currentRole === 'manager' ? `<button class="btn btn-outline btn-sm" onclick="openRate('${v.id}')" title="Update rates only">‚Çπ Rate</button>` : ''}
    </div>`).join('');
}

// =========================================================
// COLLECTION ‚Äî Step-by-step flow
// =========================================================
let collSelVendorId = null; // currently selected vendor in step 3

function initCollDate() {
  if (!document.getElementById('col-date').value) document.getElementById('col-date').value = toDay();
  collDateChanged();
}

function collDateChanged() {
  const date = document.getElementById('col-date').value || toDay();
  document.getElementById('col-date').value = date;
  document.getElementById('col-cycle').textContent = `üìÖ Cycle ${cycleName(cycleFor(date))}`;
  // Reset to step 1 when date changes
  sess = '';
  document.getElementById('sess-m').classList.remove('active');
  document.getElementById('sess-e').classList.remove('active');
  document.getElementById('coll-step2').classList.add('hidden');
  document.getElementById('coll-step3').classList.add('hidden');
  collRenderDone();
}

function collSelectSess(s) {
  if (!document.getElementById('col-date').value) {
    document.getElementById('col-date').value = toDay();
    collDateChanged();
  }
  sess = s;
  document.getElementById('sess-m').classList.toggle('active', s==='morning');
  document.getElementById('sess-e').classList.toggle('active', s==='evening');
  // Show step 2
  document.getElementById('coll-step2').classList.remove('hidden');
  document.getElementById('coll-step3').classList.add('hidden');
  collSelVendorId = null;
  // Update badge
  document.getElementById('coll-sess-badge').innerHTML =
    s === 'morning'
      ? '<span class="badge badge-morning">‚òÄÔ∏è Morning</span>'
      : '<span class="badge badge-evening">üåô Evening</span>';
  collRenderVendorList();
  collRenderDone();
  // Smooth scroll to step 2
  setTimeout(() => document.getElementById('coll-step2').scrollIntoView({behavior:'smooth', block:'nearest'}), 100);
}

function collRenderVendorList() {
  const date = document.getElementById('col-date').value;
  const el = document.getElementById('coll-vendor-list');
  if (!V.length) { el.innerHTML = '<div class="empty"><div class="ico">üë®‚Äçüåæ</div><p>No vendors added yet.</p></div>'; return; }
  const saved = {};
  C.filter(r => r.date === date && r.session === sess).forEach(r => { saved[r.vendorId] = r; });
  el.innerHTML = V.map(v => {
    const ex = saved[v.id];
    if (ex) {
      return `<div class="vendor-item" style="opacity:0.6;cursor:default;">
        <div class="vendor-avatar" style="background:var(--green);color:#001a10;">${v.name[0].toUpperCase()}</div>
        <div class="vendor-info">
          <div class="vendor-name">${v.name}</div>
          <div class="vendor-meta"><span style="color:var(--green);">‚úÖ Saved ‚Äî üêÑ${ex.cowLitres||0}L üêÉ${ex.buffaloLitres||0}L ¬∑ ‚Çπ${(ex.amount||0).toFixed(0)}</span></div>
        </div>
        <span class="locked-badge">Done</span>
      </div>`;
    }
    return `<div class="vendor-item" style="cursor:pointer;" onclick="collSelectVendor('${v.id}')">
      <div class="vendor-avatar">${v.name[0].toUpperCase()}</div>
      <div class="vendor-info">
        <div class="vendor-name">${v.name}</div>
        <div class="vendor-meta" style="margin-top:4px;display:flex;gap:6px;">
          <span class="rate-tag rate-cow">üêÑ ‚Çπ${v.cowRate}/L</span>
          <span class="rate-tag rate-buffalo">üêÉ ‚Çπ${v.buffaloRate}/L</span>
        </div>
      </div>
      <span style="color:var(--accent);font-size:18px;">‚Ä∫</span>
    </div>`;
  }).join('');
}

function collSelectVendor(vid) {
  collSelVendorId = vid;
  const v = V.find(x => x.id === vid); if (!v) return;
  // Show step 3
  document.getElementById('coll-step3').classList.remove('hidden');
  // Fill vendor info
  document.getElementById('coll-vendor-info').innerHTML = `
    <div class="vendor-avatar" style="width:36px;height:36px;font-size:14px;flex-shrink:0;">${v.name[0].toUpperCase()}</div>
    <div>
      <div style="font-weight:800;font-size:15px;">${v.name}</div>
      <div style="display:flex;gap:6px;margin-top:4px;flex-wrap:wrap;">
        <span class="rate-tag rate-cow">üêÑ ‚Çπ${v.cowRate}/L</span>
        <span class="rate-tag rate-buffalo">üêÉ ‚Çπ${v.buffaloRate}/L</span>
      </div>
    </div>`;
  // Clear inputs
  document.getElementById('coll-cow').value = '';
  document.getElementById('coll-buf').value = '';
  document.getElementById('coll-amt-preview').style.display = 'none';
  document.getElementById('coll-amt-preview').textContent = '';
  setTimeout(() => document.getElementById('coll-step3').scrollIntoView({behavior:'smooth', block:'nearest'}), 100);
  document.getElementById('coll-cow').focus();
}

function collBack() {
  document.getElementById('coll-step3').classList.add('hidden');
  collSelVendorId = null;
}

function collCalcAmt() {
  if (!collSelVendorId) return;
  const v = V.find(x => x.id === collSelVendorId); if (!v) return;
  const cow = parseFloat(document.getElementById('coll-cow').value) || 0;
  const buf = parseFloat(document.getElementById('coll-buf').value) || 0;
  const preview = document.getElementById('coll-amt-preview');
  if (cow > 0 || buf > 0) {
    const amt = (cow * v.cowRate) + (buf * v.buffaloRate);
    preview.style.display = 'block';
    preview.innerHTML = `
      üí∞ Amount: ‚Çπ${amt.toFixed(2)}
      <span style="font-size:12px;font-weight:400;color:var(--muted);margin-left:8px;">
        ${cow>0?`üêÑ${cow}L√ó‚Çπ${v.cowRate}=‚Çπ${(cow*v.cowRate).toFixed(0)}`:''}
        ${cow>0&&buf>0?' + ':''}
        ${buf>0?`üêÉ${buf}L√ó‚Çπ${v.buffaloRate}=‚Çπ${(buf*v.buffaloRate).toFixed(0)}`:''}
      </span>`;
  } else {
    preview.style.display = 'none';
  }
}

async function collSubmit() {
  if (!collSelVendorId) return;
  const date = document.getElementById('col-date').value;
  if (!date) { toast('Select date first', 'error'); return; }
  if (!sheetUrl) { toast('Connect to Google Sheets first!', 'error'); return; }
  const v = V.find(x => x.id === collSelVendorId); if (!v) return;
  const cow = parseFloat(document.getElementById('coll-cow').value) || 0;
  const buf = parseFloat(document.getElementById('coll-buf').value) || 0;
  if (cow <= 0 && buf <= 0) { toast('Enter at least cow or buffalo qty', 'error'); return; }
  // Check already saved
  const alreadySaved = C.find(r => r.date === date && r.session === sess && r.vendorId === collSelVendorId);
  if (alreadySaved) { toast('Entry already saved for this vendor', 'error'); return; }
  const rec = { id: uid(), date, session: sess, vendorId: v.id, vendorName: v.name, cowLitres: cow, buffaloLitres: buf, cowRate: v.cowRate, buffaloRate: v.buffaloRate, amount: (cow*v.cowRate)+(buf*v.buffaloRate) };
  C.push(rec);
  // Hide step 3, refresh vendor list
  document.getElementById('coll-step3').classList.add('hidden');
  collSelVendorId = null;
  collRenderVendorList();
  collRenderDone();
  renderDash();
  const ok = await sync('saveCollection', { records: [rec] });
  if (ok) { toast(`‚úÖ ${v.name} saved ‚Äî ‚Çπ${rec.amount.toFixed(0)}`); }
  else { C = C.filter(c => c.id !== rec.id); collRenderVendorList(); collRenderDone(); toast('‚ùå Failed to save. Check connection.', 'error'); }
}

function collRenderDone() {
  const date = document.getElementById('col-date').value || toDay();
  const el = document.getElementById('coll-done-list');
  if (!sess) { el.innerHTML = ''; return; }
  const done = C.filter(r => r.date === date && r.session === sess);
  if (!done.length) { el.innerHTML = ''; return; }
  const total = done.reduce((a,r) => a+(r.amount||0), 0);
  el.innerHTML = `<div class="card">
    <div class="card-title"><span>${sess==='morning'?'‚òÄÔ∏è':'üåô'}</span> ${sess==='morning'?'Morning':'Evening'} Entries ‚Äî ${fmtDate(date)}
      <span style="margin-left:auto;font-size:13px;color:var(--accent);">‚Çπ${total.toFixed(0)}</span>
    </div>
    ${done.map(r => `<div class="vendor-entry locked" style="margin-bottom:8px;">
      <div class="vendor-entry-header">
        <span style="width:24px;height:24px;background:var(--green);border-radius:6px;display:flex;align-items:center;justify-content:center;font-weight:800;font-size:11px;color:#001a10;">${r.vendorName[0].toUpperCase()}</span>
        ${r.vendorName} <span class="locked-badge">‚úÖ Saved</span>
      </div>
      <div class="entry-fields">
        <div class="entry-field"><label>üêÑ Cow</label><div class="saved-val">${r.cowLitres||0} L</div></div>
        <div class="entry-field"><label>üêÉ Buffalo</label><div class="saved-val">${r.buffaloLitres||0} L</div></div>
        <div class="entry-field"><label>Amount</label><div class="saved-val">‚Çπ${(r.amount||0).toFixed(0)}</div></div>
      </div>
    </div>`).join('')}
  </div>`;
}

// =========================================================
// PAYMENTS
// =========================================================
function renderPay() {
  const mo=parseInt(document.getElementById('pm').value), yr=parseInt(document.getElementById('py').value), cy=parseInt(document.getElementById('pc').value);
  const {s,e} = cycleDates(yr,mo,cy);
  const el = document.getElementById('pay-list');
  if (!V.length) { el.innerHTML = '<div class="empty"><div class="ico">üí∞</div><p>No vendors yet.</p></div>'; return; }
  const cols = C.filter(r=>r.date>=s && r.date<=e);
  el.innerHTML = V.map(v => {
    const vc = cols.filter(r=>r.vendorId===v.id);
    const tCow=vc.reduce((a,r)=>a+(r.cowLitres||0),0), tBuf=vc.reduce((a,r)=>a+(r.buffaloLitres||0),0);
    const gross=vc.reduce((a,r)=>a+(r.amount||0),0);
    const pk=`${v.id}_${s}`, ep=P.find(p=>p.key===pk);
    const paid=ep?ep.paidAmount:0, bal=gross-paid;
    return `<div class="payment-card">
      <div class="payment-header" onclick="togPay('pp${v.id}')">
        <div class="vendor-avatar" style="width:34px;height:34px;font-size:13px;">${v.name[0].toUpperCase()}</div>
        <div style="flex:1;"><div style="font-weight:700;font-size:14px;">${v.name}</div><div style="font-size:11px;color:var(--muted);">${fmtDate(s)} ‚Äì ${fmtDate(e)}</div></div>
        <div style="text-align:right;"><div class="amount-big">‚Çπ${gross.toFixed(0)}</div><div>${bal<=0?'<span class="paid-tag">‚úÖ PAID</span>':`<span class="pending-tag">‚Çπ${bal.toFixed(0)} pending</span>`}</div></div>
      </div>
      <div class="payment-body hidden" id="pp${v.id}">
        <div class="payment-stat"><span class="lbl">üêÑ Cow</span><span class="val">${tCow.toFixed(1)}L √ó ‚Çπ${v.cowRate} = ‚Çπ${(tCow*v.cowRate).toFixed(0)}</span></div>
        <div class="payment-stat"><span class="lbl">üêÉ Buffalo</span><span class="val">${tBuf.toFixed(1)}L √ó ‚Çπ${v.buffaloRate} = ‚Çπ${(tBuf*v.buffaloRate).toFixed(0)}</span></div>
        <div class="payment-stat"><span class="lbl">Gross</span><span class="val" style="color:var(--accent);">‚Çπ${gross.toFixed(2)}</span></div>
        <div class="payment-stat"><span class="lbl">Paid</span><span class="val" style="color:var(--green);">‚Çπ${paid.toFixed(2)}</span></div>
        <div class="payment-stat"><span class="lbl">Balance</span><span class="val" style="color:${bal>0?'var(--morning)':'var(--green)'};">‚Çπ${bal.toFixed(2)}</span></div>
        ${ep?`<div class="payment-stat"><span class="lbl">Mode</span><span class="val">${ep.note||''}</span></div>`:''}
        ${gross>0?`<button class="btn btn-primary btn-sm" style="margin-top:10px;" onclick="openPay('${v.id}','${s}','${e}',${gross},${paid})">üí≥ ${paid>0?'Update':'Record'} Payment</button>`:''}
      </div>
    </div>`;
  }).join('');
}

function togPay(id) { const el=document.getElementById(id); if(el) el.classList.toggle('hidden'); }

function openPay(vid, cs, ce, gross, paid) {
  const v=V.find(x=>x.id===vid);
  payData={vid,cs,ce,gross};
  document.getElementById('pay-vid').value=vid;
  document.getElementById('pay-info').textContent=`${v.name} ¬∑ ${fmtDate(cs)} to ${fmtDate(ce)}`;
  document.getElementById('pay-due').textContent=`‚Çπ${(gross-paid).toFixed(2)}`;
  document.getElementById('pay-amt').value=(gross-paid).toFixed(2);
  document.getElementById('pay-modal').classList.remove('hidden');
}

async function confirmPay() {
  const {vid,cs,ce,gross}=payData;
  const v=V.find(x=>x.id===vid);
  const paidAmt=parseFloat(document.getElementById('pay-amt').value)||0;
  const note=document.getElementById('pay-mode').value;
  const pk=`${vid}_${cs}`;
  const vc=C.filter(r=>r.vendorId===vid&&r.date>=cs&&r.date<=ce);
  const po={id:uid(),key:pk,vendorId:vid,vendorName:v.name,cycleStart:cs,cycleEnd:ce,totalCowL:vc.reduce((a,r)=>a+(r.cowLitres||0),0),totalBuffaloL:vc.reduce((a,r)=>a+(r.buffaloLitres||0),0),cowRate:v.cowRate,buffaloRate:v.buffaloRate,grossAmount:gross,paidAmount:paidAmt,balance:gross-paidAmt,note,paidAt:new Date().toISOString()};
  P=P.filter(p=>p.key!==pk); P.push(po);
  closePay(); renderPay();
  const ok=await sync('savePayment',{payment:po});
  if (ok) { toast('‚úÖ Payment recorded!'); renderDash(); }
  else toast('‚ùå Payment save failed', 'error');
}
function closePay() { document.getElementById('pay-modal').classList.add('hidden'); }

// =========================================================
// RECORDS
// =========================================================
function updRecSel() {
  document.getElementById('rec-v').innerHTML='<option value="">All Vendors</option>'+V.map(v=>`<option value="${v.id}">${v.name}</option>`).join('');
}
function renderRec() {
  let data=[...C];
  const vf=document.getElementById('rec-v').value, sf=document.getElementById('rec-s').value;
  if (vf) data=data.filter(r=>r.vendorId===vf);
  if (sf) data=data.filter(r=>r.session===sf);
  data.sort((a,b)=>b.date.localeCompare(a.date)||(a.session==='morning'?-1:1));
  const wrap=document.getElementById('rec-wrap');
  if (!data.length) { wrap.innerHTML='<div class="empty"><div class="ico">üì≠</div><p>No records found.</p></div>'; return; }
  wrap.innerHTML=`<div style="overflow-x:auto;"><table class="data-table">
    <thead><tr><th>Date</th><th>Vendor</th><th>Session</th><th>üêÑL</th><th>üêÉL</th><th>Amount</th></tr></thead>
    <tbody>${data.map(r=>`<tr><td>${fmtDate(r.date)}</td><td>${r.vendorName}</td>
      <td><span class="badge badge-${r.session}">${r.session==='morning'?'‚òÄÔ∏è':'üåô'} ${r.session}</span></td>
      <td>${r.cowLitres||0}</td><td>${r.buffaloLitres||0}</td>
      <td style="color:var(--accent);font-weight:600;">‚Çπ${(r.amount||0).toFixed(0)}</td>
    </tr>`).join('')}</tbody>
  </table></div>`;
}

// =========================================================
// DASHBOARD
// =========================================================
function renderDash() {
  const today=toDay(), now=new Date(), cy=cycleFor(today);
  const {s,e}=cycleDates(now.getFullYear(), now.getMonth(), cy);
  const mT=C.filter(r=>r.date===today&&r.session==='morning');
  const eT=C.filter(r=>r.date===today&&r.session==='evening');
  const mL=mT.reduce((a,r)=>a+(r.cowLitres||0)+(r.buffaloLitres||0),0);
  const eL=eT.reduce((a,r)=>a+(r.cowLitres||0)+(r.buffaloLitres||0),0);
  const allToday=[...mT,...eT];
  const todayAmt=allToday.reduce((a,r)=>a+(r.amount||0),0);
  const cycleC=C.filter(r=>r.date>=s&&r.date<=e);
  const pending=V.filter(v=>{const g=cycleC.filter(r=>r.vendorId===v.id).reduce((a,r)=>a+(r.amount||0),0),pd=(P.find(p=>p.key===`${v.id}_${s}`)||{}).paidAmount||0; return g>0&&(g-pd)>0;});

  document.getElementById('dash-content').innerHTML = `
    ${!sheetUrl?`<div class="banner">‚ö†Ô∏è Not connected to Google Sheets ‚Äî data won't be saved!<button class="btn btn-primary btn-sm" onclick="openSettings()">Connect</button></div>`:''}
    <div class="stats-row">
      <div class="stat-box"><div class="stat-num accent">${V.length}</div><div class="stat-label">Total Vendors</div></div>
      <div class="stat-box"><div class="stat-num green">${cycleName(cy)}</div><div class="stat-label">Current Cycle</div></div>
      <div class="stat-box"><div class="stat-num blue">${mL.toFixed(1)}L</div><div class="stat-label">Today Morning</div></div>
      <div class="stat-box"><div class="stat-num purple">${eL.toFixed(1)}L</div><div class="stat-label">Today Evening</div></div>
    </div>
    <div class="card">
      <div class="card-title"><span>üìÖ</span> Today's Collection ${todayAmt>0?`<span style="margin-left:auto;font-size:13px;color:var(--accent);">‚Çπ${todayAmt.toFixed(0)}</span>`:''}
      </div>
      ${!allToday.length?'<div class="empty" style="padding:16px"><div class="ico">üì≠</div><p>No collection recorded today.</p></div>'
      :`<div style="overflow-x:auto;"><table class="data-table"><thead><tr><th>Vendor</th><th>Session</th><th>üêÑL</th><th>üêÉL</th><th>Amount</th></tr></thead><tbody>
        ${allToday.map(r=>`<tr><td>${r.vendorName}</td><td><span class="badge badge-${r.session}">${r.session==='morning'?'‚òÄÔ∏è':'üåô'}</span></td><td>${r.cowLitres||0}</td><td>${r.buffaloLitres||0}</td><td style="color:var(--accent);font-weight:700;">‚Çπ${(r.amount||0).toFixed(0)}</td></tr>`).join('')}
        <tr><td colspan="4" style="font-weight:800;">Total</td><td style="color:var(--accent);font-weight:800;font-size:15px;">‚Çπ${todayAmt.toFixed(0)}</td></tr>
      </tbody></table></div>`}
    </div>
    <div class="card">
      <div class="card-title"><span>üí∞</span> Pending ‚Äî Cycle ${cycleName(cy)}</div>
      ${!pending.length?'<div class="empty" style="padding:16px"><div class="ico">‚úÖ</div><p>All payments up to date.</p></div>'
      :pending.map(v=>{const g=cycleC.filter(r=>r.vendorId===v.id).reduce((a,r)=>a+(r.amount||0),0),pd=(P.find(p=>p.key===`${v.id}_${s}`)||{}).paidAmount||0;return`<div style="display:flex;justify-content:space-between;align-items:center;padding:10px 12px;border:1px solid var(--border);border-radius:var(--radius-sm);margin-bottom:8px;background:var(--surface2);"><div><div style="font-weight:700;">${v.name}</div><div style="font-size:11px;color:var(--muted);">Cycle ${cycleName(cy)}</div></div><div style="color:var(--morning);font-weight:800;font-size:16px;">‚Çπ${(g-pd).toFixed(0)}</div></div>`;}).join('')}
    </div>`;
}

// =========================================================
// VENDOR REPORT
// =========================================================
function updRptSel() {
  const sel=document.getElementById('rv'), cur=sel.value;
  sel.innerHTML='<option value="">Select Vendor</option>'+V.map(v=>`<option value="${v.id}">${v.name}</option>`).join('');
  if(cur) sel.value=cur;
}
function renderReport() {
  const vid=document.getElementById('rv').value, mo=parseInt(document.getElementById('rm').value), yr=parseInt(document.getElementById('ry').value), cy=parseInt(document.getElementById('rc').value);
  const out=document.getElementById('report-out');
  if (!vid) { out.innerHTML='<div class="card"><div class="empty"><div class="ico">üë®‚Äçüåæ</div><p>Select a vendor to view report.</p></div></div>'; return; }
  const vendor=V.find(v=>v.id===vid); if(!vendor) return;
  const ms=String(mo+1).padStart(2,'0'), ld=new Date(yr,mo+1,0).getDate();
  const ds=cy===0?`${yr}-${ms}-01`:cycleDates(yr,mo,cy).s;
  const de=cy===0?`${yr}-${ms}-${String(ld).padStart(2,'0')}`:cycleDates(yr,mo,cy).e;
  const vc=C.filter(r=>r.vendorId===vid&&r.date>=ds&&r.date<=de);
  if (!vc.length) { out.innerHTML=`<div class="card"><div class="empty"><div class="ico">üì≠</div><p>No data for ${vendor.name} in this period.</p></div></div>`; return; }
  const byDate={};
  vc.forEach(r=>{if(!byDate[r.date])byDate[r.date]={morning:null,evening:null};byDate[r.date][r.session]=r;});
  const dates=Object.keys(byDate).sort();
  let tc=0,tb=0,ta=0,mc=0,mb=0,ma=0,ec=0,eb=0,ea=0;
  vc.forEach(r=>{tc+=r.cowLitres||0;tb+=r.buffaloLitres||0;ta+=r.amount||0;if(r.session==='morning'){mc+=r.cowLitres||0;mb+=r.buffaloLitres||0;ma+=r.amount||0;}else{ec+=r.cowLitres||0;eb+=r.buffaloLitres||0;ea+=r.amount||0;}});
  const MN=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  const cycLbl=cy===0?'Full Month':`Cycle ${cycleName(cy)}`;
  out.innerHTML=`
    <div class="card">
      <div class="card-title"><span>üë®‚Äçüåæ</span> ${vendor.name} <span style="font-size:12px;color:var(--muted);font-weight:400;">${MN[mo]} ${yr} ¬∑ ${cycLbl}</span></div>
      <div style="display:flex;gap:6px;margin-bottom:14px;flex-wrap:wrap;"><span class="rate-tag rate-cow">üêÑ ‚Çπ${vendor.cowRate}/L</span><span class="rate-tag rate-buffalo">üêÉ ‚Çπ${vendor.buffaloRate}/L</span></div>
      <div class="report-summary-grid">
        <div class="report-stat"><div class="rnum" style="color:var(--accent);">‚Çπ${ta.toFixed(0)}</div><div class="rlbl">Total Amount</div></div>
        <div class="report-stat"><div class="rnum" style="color:var(--cow);">${tc.toFixed(1)}L</div><div class="rlbl">üêÑ Cow Total</div></div>
        <div class="report-stat"><div class="rnum" style="color:var(--buffalo);">${tb.toFixed(1)}L</div><div class="rlbl">üêÉ Buffalo Total</div></div>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
        <div style="background:rgba(251,191,36,0.07);border:1px solid rgba(251,191,36,0.2);border-radius:var(--radius-sm);padding:12px;"><div style="font-size:11px;font-weight:700;color:var(--morning);margin-bottom:6px;">‚òÄÔ∏è MORNING</div><div style="font-size:13px;font-weight:600;">üêÑ ${mc.toFixed(1)}L ¬∑ üêÉ ${mb.toFixed(1)}L</div><div style="font-size:16px;font-weight:800;color:var(--accent);margin-top:4px;">‚Çπ${ma.toFixed(0)}</div></div>
        <div style="background:rgba(129,140,248,0.07);border:1px solid rgba(129,140,248,0.2);border-radius:var(--radius-sm);padding:12px;"><div style="font-size:11px;font-weight:700;color:var(--evening);margin-bottom:6px;">üåô EVENING</div><div style="font-size:13px;font-weight:600;">üêÑ ${ec.toFixed(1)}L ¬∑ üêÉ ${eb.toFixed(1)}L</div><div style="font-size:16px;font-weight:800;color:var(--accent);margin-top:4px;">‚Çπ${ea.toFixed(0)}</div></div>
      </div>
    </div>
    <div class="card">
      <div class="card-title"><span>üìÖ</span> Day-wise Detail</div>
      <div style="background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius-sm);overflow:hidden;">
        <div class="sub-hdr"><div class="day-col dc-date">Date</div><div class="day-col">Session</div><div class="day-col dc-num">üêÑL</div><div class="day-col dc-num">üêÉL</div><div class="day-col dc-amt">‚Çπ Amt</div></div>
        ${dates.map(dt=>{const d=byDate[dt];const rows=[];if(d.morning)rows.push({s:'morning',r:d.morning});if(d.evening)rows.push({s:'evening',r:d.evening});return rows.map((it,i)=>`<div class="day-row"><div class="day-col dc-date">${i===0?fmtDate(dt):''}</div><div class="day-col"><span class="badge badge-${it.s}">${it.s==='morning'?'‚òÄÔ∏è':'üåô'} ${it.s}</span></div><div class="day-col dc-num">${it.r.cowLitres||0}</div><div class="day-col dc-num">${it.r.buffaloLitres||0}</div><div class="day-col dc-amt">‚Çπ${(it.r.amount||0).toFixed(0)}</div></div>`).join('');}).join('')}
        <div class="day-row" style="background:rgba(245,166,35,0.06);border-top:1px solid var(--border);"><div class="day-col dc-date" style="font-weight:800;">TOTAL</div><div class="day-col"></div><div class="day-col dc-num" style="font-weight:700;color:var(--cow);">${tc.toFixed(1)}</div><div class="day-col dc-num" style="font-weight:700;color:var(--buffalo);">${tb.toFixed(1)}</div><div class="day-col dc-amt" style="font-size:15px;">‚Çπ${ta.toFixed(0)}</div></div>
      </div>
    </div>`;
}

// =========================================================
// OUTSTANDING LEDGER
// =========================================================

let osCurrentView = 'all'; // 'all' or 'single'

function osView(v) {
  osCurrentView = v;
  document.getElementById('os-all-btn').classList.toggle('active', v==='all');
  document.getElementById('os-single-btn').classList.toggle('active', v==='single');
  document.querySelectorAll('.os-single-only').forEach(el => el.classList.toggle('hidden', v!=='single'));
  renderOutstanding();
}

function initOutstanding() {
  const now = new Date();
  document.getElementById('os-mo').value = now.getMonth();
  document.getElementById('os-yr').value = now.getFullYear();
  // Populate vendor selector
  const sel = document.getElementById('os-vid');
  sel.innerHTML = '<option value="">Select Vendor</option>' + V.map(v=>`<option value="${v.id}">${v.name}</option>`).join('');
}

// Returns all cycles from first ever collection to given month/year end
function getAllCyclesUpTo(yr, mo) {
  if (!C.length) return [];
  // Find earliest date in collection
  const earliest = C.map(r=>r.date).sort()[0];
  if (!earliest) return [];
  const [ey, em] = earliest.split('-').map(Number);
  const cycles = [];
  let cy = ey, cm = em - 1; // cm is 0-indexed month
  const endYr = yr, endMo = mo; // 0-indexed
  while (cy < endYr || (cy === endYr && cm <= endMo)) {
    [1,2,3].forEach(cyc => {
      const {s, e} = cycleDates(cy, cm, cyc);
      // Only include cycles up to end of selected month
      const cycEnd = `${endYr}-${String(endMo+1).padStart(2,'0')}-31`;
      if (s <= cycEnd) cycles.push({yr:cy, mo:cm, cyc, s, e});
    });
    cm++;
    if (cm > 11) { cm = 0; cy++; }
  }
  return cycles;
}

// Core: calculate running ledger for one vendor across all cycles up to selected month
// Returns array of cycle rows with: opening, gross, paid, closing
function calcVendorLedger(vid, toYr, toMo) {
  const cycles = getAllCyclesUpTo(toYr, toMo);
  let runBal = 0; // positive = we owe vendor (debit), negative = vendor advance (credit)
  const rows = [];
  cycles.forEach(({yr, mo, cyc, s, e}) => {
    const opening = runBal;
    const vc = C.filter(r => r.vendorId === vid && r.date >= s && r.date <= e);
    const gross = vc.reduce((a,r) => a + (r.amount||0), 0);
    const pk = `${vid}_${s}`;
    const ep = P.find(p => p.key === pk);
    const paid = ep ? (ep.paidAmount||0) : 0;
    // closing = opening + gross - paid
    // positive closing = we still owe (debit to us)
    // negative closing = vendor overpaid / advance (credit for next cycle)
    const closing = opening + gross - paid;
    runBal = closing;
    // Only include in current month view ‚Äî but always run all cycles for carry-forward
    if (yr === toYr && mo === toMo) {
      rows.push({ yr, mo, cyc, s, e, opening, gross, paid, closing });
    }
  });
  return { rows, finalBalance: runBal };
}

function renderOutstanding() {
  const mo = parseInt(document.getElementById('os-mo').value);
  const yr = parseInt(document.getElementById('os-yr').value);
  const out = document.getElementById('outstanding-out');
  if (!V.length) { out.innerHTML = '<div class="card"><div class="empty"><div class="ico">üë§</div><p>No vendors yet.</p></div></div>'; return; }
  const MN = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];

  if (osCurrentView === 'all') {
    renderOutstandingAll(mo, yr, MN, out);
  } else {
    const vid = document.getElementById('os-vid').value;
    if (!vid) { out.innerHTML = '<div class="card"><div class="empty"><div class="ico">üë§</div><p>Select a vendor to view ledger.</p></div></div>'; return; }
    renderOutstandingSingle(vid, mo, yr, MN, out);
  }
}

function renderOutstandingAll(mo, yr, MN, out) {
  let totalDebit = 0, totalCredit = 0, totalSettled = 0;
  const rows = V.map(v => {
    const { rows: cycRows, finalBalance } = calcVendorLedger(v.id, yr, mo);
    const bal = finalBalance; // balance at END of selected month
    if (bal > 0.005) totalDebit += bal;
    else if (bal < -0.005) totalCredit += Math.abs(bal);
    else totalSettled++;
    return { v, bal, cycRows };
  }).sort((a,b) => Math.abs(b.bal) - Math.abs(a.bal));

  const summaryHtml = `
    <div class="card">
      <div class="card-title"><span>üìä</span> Summary ‚Äî ${MN[mo]} ${yr}</div>
      <div class="summary-grid">
        <div class="summary-box">
          <div class="snum os-debit">‚Çπ${totalDebit.toFixed(0)}</div>
          <div class="slbl">Total Debit (We Owe)</div>
        </div>
        <div class="summary-box">
          <div class="snum os-credit">‚Çπ${totalCredit.toFixed(0)}</div>
          <div class="slbl">Total Advance (Vendor Overpaid)</div>
        </div>
        <div class="summary-box">
          <div class="snum os-zero">${totalSettled}</div>
          <div class="slbl">Fully Settled</div>
        </div>
      </div>
    </div>`;

  const vendorCards = rows.map(({v, bal, cycRows}) => {
    const balClass = bal > 0.005 ? 'os-debit' : bal < -0.005 ? 'os-credit' : 'os-zero';
    const balLabel = bal > 0.005 ? 'üî¥ We Owe' : bal < -0.005 ? 'üü¢ Advance' : '‚úÖ Settled';
    const balDisplay = bal > 0.005 ? `‚Çπ${bal.toFixed(0)}` : bal < -0.005 ? `‚Çπ${Math.abs(bal).toFixed(0)} advance` : '‚Çπ0';

    // Cycle breakdown for this month
    const cycleDetail = cycRows.map(row => {
      const cBal = row.closing;
      const cClass = cBal > 0.005 ? 'os-debit' : cBal < -0.005 ? 'os-credit' : 'os-zero';
      return `<div class="ledger-row">
        <div>
          <div class="ledger-cycle">Cycle ${cycleName(row.cyc)} (${fmtDate(row.s)}‚Äì${fmtDate(row.e)})</div>
          <div style="font-size:11px;color:var(--muted);margin-top:2px;">
            Opening: <span style="color:${row.opening>0.005?'var(--morning)':row.opening<-0.005?'var(--green)':'var(--muted)'};">‚Çπ${row.opening.toFixed(0)}</span>
            &nbsp;+&nbsp; Gross: <span style="color:var(--accent);">‚Çπ${row.gross.toFixed(0)}</span>
            &nbsp;‚àí&nbsp; Paid: <span style="color:var(--green);">‚Çπ${row.paid.toFixed(0)}</span>
          </div>
        </div>
        <div class="ledger-val ${cClass}">‚Çπ${Math.abs(cBal).toFixed(0)}<br><span style="font-size:9px;font-weight:400;">${cBal>0.005?'due':cBal<-0.005?'advance':'settled'}</span></div>
      </div>`;
    }).join('') || `<div style="font-size:12px;color:var(--muted);padding:10px 0;">No collection this month</div>`;

    return `<div class="os-card">
      <div class="os-header" onclick="this.nextElementSibling.classList.toggle('hidden')">
        <div class="vendor-avatar" style="width:34px;height:34px;font-size:13px;">${v.name[0].toUpperCase()}</div>
        <div style="flex:1;">
          <div style="font-weight:700;font-size:14px;">${v.name}</div>
          <div style="font-size:11px;color:var(--muted);">${balLabel}</div>
        </div>
        <div class="ledger-val ${balClass}" style="font-size:16px;">${balDisplay}</div>
      </div>
      <div class="os-body hidden">
        <div style="font-size:11px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:0.5px;padding:10px 0 6px;">This Month Cycle Breakdown</div>
        ${cycleDetail}
        <div class="ledger-total-row">
          <span>Closing Balance ‚Äî ${MN[mo]} ${yr}</span>
          <span class="${balClass}">${balDisplay}</span>
        </div>
      </div>
    </div>`;
  }).join('');

  out.innerHTML = summaryHtml + vendorCards;
}

function renderOutstandingSingle(vid, mo, yr, MN, out) {
  const v = V.find(x => x.id === vid);
  if (!v) return;
  const { rows } = calcVendorLedger(v.id, yr, mo);

  if (!rows.length) {
    out.innerHTML = `<div class="card"><div class="empty"><div class="ico">üì≠</div><p>No data for ${v.name} in ${MN[mo]} ${yr}.</p></div></div>`;
    return;
  }

  const monthGross = rows.reduce((a,r) => a+r.gross, 0);
  const monthPaid  = rows.reduce((a,r) => a+r.paid, 0);
  const openingBal = rows[0].opening;
  const closingBal = rows[rows.length-1].closing;
  const balClass = closingBal > 0.005 ? 'os-debit' : closingBal < -0.005 ? 'os-credit' : 'os-zero';

  const summaryHtml = `
    <div class="card">
      <div class="card-title"><span>üë§</span> ${v.name} ‚Äî ${MN[mo]} ${yr}</div>
      <div class="summary-grid">
        <div class="summary-box">
          <div class="snum" style="color:${openingBal>0.005?'var(--morning)':openingBal<-0.005?'var(--green)':'var(--muted)'};">
            ${openingBal>0.005?'‚Çπ'+openingBal.toFixed(0):openingBal<-0.005?'‚Çπ'+Math.abs(openingBal).toFixed(0)+' adv':'‚Çπ0'}
          </div>
          <div class="slbl">Opening Balance</div>
        </div>
        <div class="summary-box">
          <div class="snum" style="color:var(--accent);">‚Çπ${monthGross.toFixed(0)}</div>
          <div class="slbl">Total Collection</div>
        </div>
        <div class="summary-box">
          <div class="snum" style="color:var(--green);">‚Çπ${monthPaid.toFixed(0)}</div>
          <div class="slbl">Total Paid</div>
        </div>
      </div>
    </div>`;

  const ledgerHtml = `
    <div class="card">
      <div class="card-title"><span>üìí</span> Cycle Ledger</div>
      <div style="background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius-sm);overflow:hidden;">
        <!-- Header -->
        <div style="display:grid;grid-template-columns:1.5fr 1fr 1fr 1fr 1fr;padding:8px 12px;font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:0.5px;color:var(--muted);border-bottom:1px solid var(--border);">
          <div>Cycle</div><div style="text-align:right;">Opening</div><div style="text-align:right;">Gross</div><div style="text-align:right;">Paid</div><div style="text-align:right;">Closing</div>
        </div>
        ${rows.map(row => {
          const cClass = row.closing > 0.005 ? 'os-debit' : row.closing < -0.005 ? 'os-credit' : 'os-zero';
          const oClass = row.opening > 0.005 ? 'os-debit' : row.opening < -0.005 ? 'os-credit' : 'os-zero';
          const oLabel = row.opening > 0.005 ? '‚Üë b/f' : row.opening < -0.005 ? '‚Üë adv' : '';
          return `<div style="display:grid;grid-template-columns:1.5fr 1fr 1fr 1fr 1fr;padding:10px 12px;border-bottom:1px solid rgba(255,255,255,0.04);font-size:12px;">
            <div>
              <div style="font-weight:700;">Cycle ${cycleName(row.cyc)}</div>
              <div style="font-size:10px;color:var(--muted);">${fmtDate(row.s)}‚Äì${fmtDate(row.e)}</div>
            </div>
            <div style="text-align:right;" class="${oClass}">${row.opening!==0?'‚Çπ'+Math.abs(row.opening).toFixed(0)+'<br><span style="font-size:9px;">'+oLabel+'</span>':'‚Äî'}</div>
            <div style="text-align:right;color:var(--accent);font-weight:600;">${row.gross>0?'‚Çπ'+row.gross.toFixed(0):'‚Äî'}</div>
            <div style="text-align:right;color:var(--green);font-weight:600;">${row.paid>0?'‚Çπ'+row.paid.toFixed(0):'‚Äî'}</div>
            <div style="text-align:right;font-weight:800;" class="${cClass}">${'‚Çπ'+Math.abs(row.closing).toFixed(0)}<br><span style="font-size:9px;font-weight:400;">${row.closing>0.005?'due':row.closing<-0.005?'adv':'‚úÖ'}</span></div>
          </div>`;
        }).join('')}
        <div class="ledger-total-row">
          <span>Closing Balance</span>
          <span class="${balClass}" style="font-size:15px;">${closingBal>0.005?'‚Çπ'+closingBal.toFixed(0)+' (we owe)':closingBal<-0.005?'‚Çπ'+Math.abs(closingBal).toFixed(0)+' advance':'‚úÖ Settled'}</span>
        </div>
      </div>
    </div>`;

  out.innerHTML = summaryHtml + ledgerHtml;
}

// =========================================================
// SECURITY TAB
// =========================================================
function renderSecStatus() {
  const el = document.getElementById('sec-sheet-status');
  el.innerHTML = sheetUrl
    ? `<span style="color:var(--green);">‚úÖ Connected to Google Sheets</span><br><span style="font-size:11px;color:var(--muted);word-break:break-all;">${sheetUrl.substring(0,70)}...</span>`
    : `<span style="color:var(--red);">‚ùå Not connected ‚Äî set up Google Sheets sync</span>`;
  // Show current PINs status
  const pinInfo = document.getElementById('sec-pin-info');
  if (pinInfo) {
    pinInfo.innerHTML = `
      <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:8px;">
        <span class="role-badge role-manager">üëî Manager PIN: ${getMgrPin().replace(/./g,'‚Ä¢')}</span>
        <span class="role-badge role-operator">üë∑ Operator PIN: ${getOpPin().replace(/./g,'‚Ä¢')}</span>
      </div>`;
  }
}

// =========================================================
// GOOGLE SHEETS
// =========================================================
function updateSyncUI() {
  const dot=document.getElementById('sync-dot'), lbl=document.getElementById('sync-lbl'), btn=document.getElementById('sync-btn');
  if (sheetUrl) { dot.className='sync-dot on'; lbl.textContent='üîÑ Refresh'; btn.className='sync-btn connected'; }
  else { dot.className='sync-dot'; lbl.textContent='Setup Sync'; btn.className='sync-btn'; }
}

function openSettings() {
  document.getElementById('sheet-url').value=sheetUrl;
  document.getElementById('conn-status').textContent='';
  document.getElementById('settings-modal').classList.remove('hidden');
}
function closeSettings() { document.getElementById('settings-modal').classList.add('hidden'); }

async function connectSheet() {
  const url=document.getElementById('sheet-url').value.trim();
  if (!url) { toast('Enter the Apps Script URL','error'); return; }
  const btn=document.getElementById('conn-btn'), st=document.getElementById('conn-status');
  btn.innerHTML='<div class="spinner"></div> Connecting...'; btn.disabled=true;
  st.textContent='Connecting & loading data from sheet...';
  try {
    const r=await fetch(url+'?action=getAll');
    const d=await r.json();
    if (d.success!==undefined) {
      sheetUrl=url; localStorage.setItem('yd_url',sheetUrl);
      updateSyncUI();
      await loadSheet(d);
      st.textContent=`‚úÖ Connected! Loaded ${V.length} vendors, ${C.length} collection records.`;
      st.style.color='var(--green)';
      toast('‚úÖ Connected & all data loaded!');
      setTimeout(closeSettings, 2000);
    } else throw new Error('Bad response');
  } catch(err) {
    st.textContent='‚ùå Connection failed. Check URL & ensure deployment is set to "Anyone".';
    st.style.color='var(--red)';
  }
  btn.innerHTML='üîó Connect & Load Data'; btn.disabled=false;
}

async function pullFromSheet() {
  if (!sheetUrl) { toast('Not connected','error'); return; }
  toast('üîÑ Refreshing...','success');
  try {
    const r=await fetch(sheetUrl+'?action=getAll');
    const d=await r.json();
    if (!d.success) throw new Error('Failed');
    await loadSheet(d);
    toast('‚úÖ Data refreshed!'); closeSettings();
  } catch(e) { toast('‚ùå Refresh failed: '+e.message,'error'); }
}

async function pull(silent=false) {
  if (!sheetUrl) return;
  try {
    const r = await fetch(sheetUrl+'?action=getAll');
    if (!r.ok && r.status !== 0) throw new Error('HTTP '+r.status);
    const d = await r.json();
    if (!d.success) throw new Error('Sheet returned error');
    await loadSheet(d);
  } catch(e) {
    console.warn('Pull error:', e);
    if (!silent) toast('‚ùå Failed to load data. Check internet.','error');
    else showNoInternetScreen();
  }
}

async function loadSheet(d) {
  // Always replace from sheet ‚Äî sheet is single source of truth
  V=[];C=[];P=[];
  if (d.vendors) d.vendors.forEach(sv=>V.push({id:String(sv.ID),name:sv.Name||'',phone:sv.Phone||'',address:sv.Address||'',cowRate:parseFloat(sv.CowRate)||0,buffaloRate:parseFloat(sv.BuffaloRate)||0}));
  if (d.collections) d.collections.forEach(sc=>C.push({id:String(sc.ID),date:String(sc.Date).substring(0,10),session:sc.Session||'',vendorId:String(sc.VendorID),vendorName:sc.VendorName||'',cowLitres:parseFloat(sc.CowLitres)||0,buffaloLitres:parseFloat(sc.BuffaloLitres)||0,amount:parseFloat(sc.Amount)||0}));
  if (d.payments) d.payments.forEach(sp=>P.push({id:String(sp.ID),key:`${sp.VendorID}_${String(sp.CycleStart).substring(0,10)}`,vendorId:String(sp.VendorID),vendorName:sp.VendorName||'',cycleStart:String(sp.CycleStart).substring(0,10),cycleEnd:String(sp.CycleEnd).substring(0,10),grossAmount:parseFloat(sp.GrossAmount)||0,paidAmount:parseFloat(sp.PaidAmount)||0,balance:parseFloat(sp.Balance)||0,cowRate:parseFloat(sp.CowRate)||0,buffaloRate:parseFloat(sp.BuffaloRate)||0,note:sp.Note||''}));
  renderVList(); renderDash();
}

async function sync(action, payload) {
  if (!sheetUrl) return false;
  try {
    const body=new FormData();
    body.append('action',action);
    body.append('payload',JSON.stringify(payload));
    await fetch(sheetUrl,{method:'POST',mode:'no-cors',body});
    return true;
  } catch(e) { console.warn('Sync failed:',e); return false; }
}

function disconnectSheet() {
  if (!confirm('Disconnect from Google Sheets?\nData will not be accessible until reconnected.')) return;
  sheetUrl=''; localStorage.removeItem('yd_url');
  V=[];C=[];P=[];
  updateSyncUI(); closeSettings(); renderDash(); renderVList();
  toast('Disconnected');
}

// =========================================================
// START
// =========================================================
initLogin();
</script>
</body>
</html>
